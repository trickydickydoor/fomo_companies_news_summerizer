name: FOMO News Analysis

on:
  # å®šæ—¶è§¦å‘ - æ¯12å°æ—¶è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 */12 * * *'  # UTCæ—¶é—´æ¯12å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆ00:00å’Œ12:00ï¼‰
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      hours:
        description: 'åˆ†æžæ—¶é—´èŒƒå›´ï¼ˆå°æ—¶ï¼‰'
        required: false
        default: '24'
        type: string
      company:
        description: 'å…¬å¸åç§°ï¼ˆå¯é€‰ï¼Œç•™ç©ºåˆ†æžæ‰€æœ‰å…¬å¸ï¼‰'
        required: false
        default: ''
        type: string
      save_to_db:
        description: 'æ˜¯å¦ä¿å­˜åˆ°æ•°æ®åº“'
        required: false
        default: false
        type: boolean
  
  # Pushè§¦å‘
  push:
    branches:
      - main
    paths:
      - '**'

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Set up environment
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
        PINECONE_INDEX_NAME: ${{ secrets.PINECONE_INDEX_NAME }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      run: |
        echo "Environment variables configured"
        echo "â„¹ï¸ ç³»ç»Ÿå·²å¯ç”¨æ–‡ç« è®¡æ•°å˜åŒ–æ£€æµ‹ - åªæœ‰æ–‡ç« æ•°é‡å˜åŒ–çš„å…¬å¸æ‰ä¼šè¢«åˆ†æž"
    
    - name: Run news analysis
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
        PINECONE_INDEX_NAME: ${{ secrets.PINECONE_INDEX_NAME }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      run: |
        # è®¾ç½®å‚æ•°
        HOURS="${{ github.event.inputs.hours || '24' }}"
        COMPANY="${{ github.event.inputs.company || '' }}"
        SAVE_DB="${{ github.event.inputs.save_to_db || 'true' }}"
        
        echo "ðŸš€ å¼€å§‹FOMOæ–°é—»åˆ†æž..."
        echo "â° åˆ†æžèŒƒå›´: ${HOURS}å°æ—¶"
        echo "ðŸ¢ ç›®æ ‡å…¬å¸: ${COMPANY:-æ‰€æœ‰å…¬å¸}"
        echo "ðŸ’¾ ä¿å­˜åˆ°æ•°æ®åº“: ${SAVE_DB}"
        echo "ðŸ“Š æ–‡ç« è®¡æ•°æ£€æµ‹: å¯ç”¨ï¼ˆåªåˆ†æžæ–‡ç« æ•°é‡æœ‰å˜åŒ–çš„å…¬å¸ï¼‰"
        
        # è¿è¡Œåˆ†æž
        python run_analysis.py \
          --hours "$HOURS" \
          --company "$COMPANY" \
          --save-db "$SAVE_DB"
    
    - name: Upload analysis results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: news-analysis-results-${{ github.run_number }}
        path: |
          output/*.json
          output/*.txt
        retention-days: 30
    
    - name: Create summary
      if: always()
      run: |
        echo "## ðŸ“Š FOMO News Analysis Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **è¿è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æžèŒƒå›´**: ${{ github.event.inputs.hours || '24' }}å°æ—¶" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›®æ ‡å…¬å¸**: ${{ github.event.inputs.company || 'æ‰€æœ‰å…¬å¸' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ‰§è¡Œé¢‘çŽ‡**: æ¯12å°æ—¶è‡ªåŠ¨è¿è¡Œ" >> $GITHUB_STEP_SUMMARY
        echo "- **æ™ºèƒ½åˆ†æž**: ä»…åˆ†æžæ–‡ç« æ•°é‡æœ‰å˜åŒ–çš„å…¬å¸" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥ç»“æžœæ–‡ä»¶
        if [ -f "output/summary.txt" ]; then
          echo "### ðŸ“ˆ åˆ†æžç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat output/summary.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ æœªæ‰¾åˆ°åˆ†æžç»“æžœæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— æŸ¥çœ‹è¯¦ç»†ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "è¯¦ç»†çš„åˆ†æžç»“æžœå·²ä¿å­˜ä¸ºArtifactsï¼Œå¯åœ¨Actionsé¡µé¢ä¸‹è½½æŸ¥çœ‹ã€‚" >> $GITHUB_STEP_SUMMARY